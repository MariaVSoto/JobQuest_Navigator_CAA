# 微服务架构和数据模型设计

## 1. 整体架构设计

基于需求分析，我们将设计两个基于Django的微服务：简历管理服务（Resume Management Service）和AI建议服务（AI Suggestion Service）。这两个服务将作为独立的Django项目进行开发，通过API进行通信。

### 1.1 系统架构图

```
+------------------+      +------------------+
|                  |      |                  |
|   API Gateway    |      |    客户端应用    |
|                  |      |                  |
+--------+---------+      +--------+---------+
         |                         |
         v                         |
+--------+---------+               |
|                  |               |
|   认证服务       |               |
|                  |               |
+------------------+               |
         ^                         |
         |                         |
+--------+---------+     +---------v--------+
|                  |     |                  |
| 简历管理服务     |<--->|  AI建议服务      |
|                  |     |                  |
+--------+---------+     +------------------+
         |                         ^
         v                         |
+--------+---------+               |
|                  |               |
|   S3存储         |               |
|                  |               |
+------------------+               |
                                   |
+------------------+               |
|                  |               |
|   MySQL数据库    |---------------+
|                  |
+------------------+
```

### 1.2 技术栈选择

- **后端框架**：Django + Django REST Framework
- **数据库**：MySQL
- **文件存储**：Amazon S3（或兼容的替代品，如MinIO）
- **API文档**：Swagger/OpenAPI
- **认证**：JWT（JSON Web Token）
- **容器化**：Docker + Docker Compose
- **AI集成**：OpenAI API

## 2. 简历管理服务（Resume Management Service）

### 2.1 项目结构

```
resume_management_service/
├── Dockerfile
├── requirements.txt
├── manage.py
├── resume_management/
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   ├── wsgi.py
│   └── asgi.py
├── api/
│   ├── __init__.py
│   ├── apps.py
│   ├── urls.py
│   ├── views/
│   │   ├── __init__.py
│   │   ├── resume_views.py
│   │   └── file_views.py
│   ├── serializers/
│   │   ├── __init__.py
│   │   └── resume_serializers.py
│   ├── models/
│   │   ├── __init__.py
│   │   └── resume_models.py
│   └── services/
│       ├── __init__.py
│       ├── s3_service.py
│       └── version_service.py
└── tests/
    ├── __init__.py
    ├── test_resume_api.py
    └── test_file_api.py
```

### 2.2 数据模型设计

#### 2.2.1 Resume模型

```python
from django.db import models
import uuid

class Resume(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    name = models.CharField(max_length=255)
    user_id = models.CharField(max_length=36)  # 外部用户ID，来自认证服务
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user_id']),
        ]

    def __str__(self):
        return f"{self.name} ({self.id})"
```

#### 2.2.2 ResumeVersion模型

```python
class ResumeVersion(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    resume = models.ForeignKey(Resume, related_name='versions', on_delete=models.CASCADE)
    file_path = models.CharField(max_length=512)  # S3路径
    file_name = models.CharField(max_length=255)
    file_size = models.IntegerField()  # 文件大小（字节）
    file_type = models.CharField(max_length=50)  # MIME类型
    comment = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['resume']),
        ]

    def __str__(self):
        return f"Version {self.id} of {self.resume.name}"

    @property
    def s3_key(self):
        # 返回S3对象的完整路径
        return f"resumes/{self.resume.user_id}/{self.resume.id}/{self.id}/{self.file_name}"
```

### 2.3 API设计

#### 2.3.1 简历API

- **POST /api/resumes**
  - 功能：上传新简历
  - 请求：`multipart/form-data`（文件 + 名称）
  - 响应：新创建的简历对象

- **GET /api/resumes**
  - 功能：列出当前用户的所有简历
  - 请求：无（从认证中获取用户ID）
  - 响应：简历对象列表

- **GET /api/resumes/{resumeId}**
  - 功能：获取特定简历及其版本
  - 请求：路径参数`resumeId`
  - 响应：简历对象，包括版本列表

- **DELETE /api/resumes/{resumeId}**
  - 功能：删除简历
  - 请求：路径参数`resumeId`
  - 响应：204 No Content

#### 2.3.2 简历版本API

- **GET /api/resumes/{resumeId}/versions**
  - 功能：列出简历的所有版本
  - 请求：路径参数`resumeId`
  - 响应：版本对象列表

- **POST /api/resumes/{resumeId}/versions**
  - 功能：为简历上传新版本
  - 请求：`multipart/form-data`（文件 + 注释）
  - 响应：新创建的版本对象

#### 2.3.3 文件API

- **GET /api/files/{fileId}**
  - 功能：下载文件（简历）
  - 请求：路径参数`fileId`
  - 响应：文件内容

- **DELETE /api/files/{fileId}**
  - 功能：删除文件
  - 请求：路径参数`fileId`
  - 响应：204 No Content

### 2.4 S3服务集成

```python
import boto3
from botocore.exceptions import ClientError
from django.conf import settings
import logging

logger = logging.getLogger(__name__)

class S3Service:
    def __init__(self):
        self.s3_client = boto3.client(
            's3',
            aws_access_key_id=settings.AWS_ACCESS_KEY_ID,
            aws_secret_access_key=settings.AWS_SECRET_ACCESS_KEY,
            region_name=settings.AWS_S3_REGION_NAME,
            endpoint_url=settings.AWS_S3_ENDPOINT_URL,  # 对于MinIO或其他S3兼容服务
        )
        self.bucket_name = settings.AWS_STORAGE_BUCKET_NAME

    def upload_file(self, file_obj, s3_key):
        """
        上传文件到S3
        
        Args:
            file_obj: 文件对象
            s3_key: S3中的对象键
            
        Returns:
            bool: 上传是否成功
        """
        try:
            self.s3_client.upload_fileobj(file_obj, self.bucket_name, s3_key)
            return True
        except ClientError as e:
            logger.error(f"Error uploading file to S3: {e}")
            return False

    def download_file(self, s3_key):
        """
        从S3下载文件
        
        Args:
            s3_key: S3中的对象键
            
        Returns:
            bytes: 文件内容
        """
        try:
            response = self.s3_client.get_object(Bucket=self.bucket_name, Key=s3_key)
            return response['Body'].read()
        except ClientError as e:
            logger.error(f"Error downloading file from S3: {e}")
            return None

    def delete_file(self, s3_key):
        """
        从S3删除文件
        
        Args:
            s3_key: S3中的对象键
            
        Returns:
            bool: 删除是否成功
        """
        try:
            self.s3_client.delete_object(Bucket=self.bucket_name, Key=s3_key)
            return True
        except ClientError as e:
            logger.error(f"Error deleting file from S3: {e}")
            return False
```

## 3. AI建议服务（AI Suggestion Service）

### 3.1 项目结构

```
ai_suggestion_service/
├── Dockerfile
├── requirements.txt
├── manage.py
├── ai_suggestion/
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   ├── wsgi.py
│   └── asgi.py
├── api/
│   ├── __init__.py
│   ├── apps.py
│   ├── urls.py
│   ├── views/
│   │   ├── __init__.py
│   │   └── suggestion_views.py
│   ├── serializers/
│   │   ├── __init__.py
│   │   └── suggestion_serializers.py
│   ├── models/
│   │   ├── __init__.py
│   │   └── suggestion_models.py
│   └── services/
│       ├── __init__.py
│       ├── openai_service.py
│       └── resume_service.py  # 与简历管理服务通信
└── tests/
    ├── __init__.py
    └── test_suggestion_api.py
```

### 3.2 数据模型设计

#### 3.2.1 Suggestion模型

```python
from django.db import models
import uuid

class Suggestion(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user_id = models.CharField(max_length=36)  # 外部用户ID，来自认证服务
    resume_id = models.CharField(max_length=36)  # 简历ID，来自简历管理服务
    job_description = models.TextField()
    score = models.FloatField()  # 匹配分数
    feedback = models.TextField()  # AI反馈
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['user_id']),
            models.Index(fields=['resume_id']),
        ]

    def __str__(self):
        return f"Suggestion for resume {self.resume_id} (Score: {self.score})"
```

#### 3.2.2 SuggestionFeedback模型

```python
class SuggestionFeedback(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    suggestion = models.ForeignKey(Suggestion, related_name='feedbacks', on_delete=models.CASCADE)
    is_helpful = models.BooleanField()
    comment = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return f"Feedback for suggestion {self.suggestion.id}"
```

### 3.3 API设计

#### 3.3.1 建议API

- **POST /api/suggestions**
  - 功能：获取简历和工作描述的AI推荐
  - 请求：JSON（简历ID + 工作描述）
  - 响应：AI建议对象

- **GET /api/suggestions**
  - 功能：列出当前用户的AI建议
  - 请求：无（从认证中获取用户ID）
  - 响应：建议对象列表

#### 3.3.2 反馈API（扩展）

- **POST /api/suggestions/{suggestionId}/feedback**
  - 功能：提交对建议的反馈
  - 请求：JSON（是否有帮助 + 评论）
  - 响应：反馈对象

### 3.4 OpenAI服务集成

```python
import openai
from django.conf import settings
import logging

logger = logging.getLogger(__name__)

class OpenAIService:
    def __init__(self):
        openai.api_key = settings.OPENAI_API_KEY

    def analyze_resume_job_match(self, resume_text, job_description):
        """
        分析简历和工作描述的匹配度
        
        Args:
            resume_text: 简历文本
            job_description: 工作描述
            
        Returns:
            dict: 包含分数和反馈的字典
        """
        try:
            response = openai.ChatCompletion.create(
                model="gpt-4",
                messages=[
                    {"role": "system", "content": "You are an expert resume reviewer and job application advisor."},
                    {"role": "user", "content": f"I want to apply for this job:\n\n{job_description}\n\nHere is my resume:\n\n{resume_text}\n\nPlease analyze how well my resume matches this job. Give me a match score from 0 to 100 and specific feedback on how to improve my resume for this job."}
                ],
                temperature=0.7,
            )
            
            # 解析响应
            content = response.choices[0].message.content
            
            # 这里需要一些逻辑来从内���中提取分数
            # 这是一个简化的示例
            import re
            score_match = re.search(r'(\d+)/100', content)
            score = float(score_match.group(1)) if score_match else 50.0
            
            return {
                "score": score,
                "feedback": content
            }
        except Exception as e:
            logger.error(f"Error calling OpenAI API: {e}")
            return {
                "score": 0.0,
                "feedback": "Error analyzing resume. Please try again later."
            }
```

### 3.5 简历服务集成

```python
import requests
from django.conf import settings
import logging

logger = logging.getLogger(__name__)

class ResumeService:
    def __init__(self):
        self.base_url = settings.RESUME_SERVICE_URL
        
    def get_resume(self, resume_id, user_id, auth_token):
        """
        从简历管理服务获取简历
        
        Args:
            resume_id: 简历ID
            user_id: 用户ID
            auth_token: 认证令牌
            
        Returns:
            dict: 简历对象
        """
        try:
            headers = {
                'Authorization': f'Bearer {auth_token}'
            }
            response = requests.get(
                f"{self.base_url}/api/resumes/{resume_id}",
                headers=headers
            )
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            logger.error(f"Error fetching resume from Resume Service: {e}")
            return None
            
    def get_resume_file(self, file_id, auth_token):
        """
        从简历管理服务获取简历文件
        
        Args:
            file_id: 文件ID
            auth_token: 认证令牌
            
        Returns:
            bytes: 文件内容
        """
        try:
            headers = {
                'Authorization': f'Bearer {auth_token}'
            }
            response = requests.get(
                f"{self.base_url}/api/files/{file_id}",
                headers=headers
            )
            response.raise_for_status()
            return response.content
        except requests.exceptions.RequestException as e:
            logger.error(f"Error fetching resume file from Resume Service: {e}")
            return None
```

## 4. 认证和安全

### 4.1 JWT认证

两个微服务都将使用JWT进行认证。JWT令牌由认证服务生成，并由API网关验证。

```python
# settings.py
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
}

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),
    'ALGORITHM': 'HS256',
    'SIGNING_KEY': settings.SECRET_KEY,
    'AUTH_HEADER_TYPES': ('Bearer',),
}
```

### 4.2 CORS配置

```python
# settings.py
INSTALLED_APPS = [
    # ...
    'corsheaders',
    # ...
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    # ...
]

# 允许所有来源的跨域请求
CORS_ALLOW_ALL_ORIGINS = True

# 或者指定允许的来源
# CORS_ALLOWED_ORIGINS = [
#     "http://localhost:3000",
#     "http://127.0.0.1:3000",
# ]
```

## 5. 部署配置

### 5.1 Docker配置

#### 5.1.1 简历管理服务Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "resume_management.wsgi:application"]
```

#### 5.1.2 AI建议服务Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8001

CMD ["gunicorn", "--bind", "0.0.0.0:8001", "ai_suggestion.wsgi:application"]
```

### 5.2 Docker Compose配置

```yaml
version: '3'

services:
  resume-service:
    build: ./resume_management_service
    ports:
      - "8000:8000"
    environment:
      - DEBUG=0
      - SECRET_KEY=${RESUME_SECRET_KEY}
      - DATABASE_URL=mysql://${DB_USER}:${DB_PASSWORD}@db:3306/resume_db
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_STORAGE_BUCKET_NAME=${AWS_STORAGE_BUCKET_NAME}
      - AWS_S3_REGION_NAME=${AWS_S3_REGION_NAME}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL}
    depends_on:
      - db
    restart: always

  ai-suggestion-service:
    build: ./ai_suggestion_service
    ports:
      - "8001:8001"
    environment:
      - DEBUG=0
      - SECRET_KEY=${AI_SECRET_KEY}
      - DATABASE_URL=mysql://${DB_USER}:${DB_PASSWORD}@db:3306/ai_suggestion_db
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - RESUME_SERVICE_URL=http://resume-service:8000
    depends_on:
      - db
      - resume-service
    restart: always

  db:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_DATABASE=resume_db
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: always

volumes:
  mysql_data:
```

### 5.3 初始化数据库脚本

```sql
-- init.sql
CREATE DATABASE IF NOT EXISTS resume_db;
CREATE DATABASE IF NOT EXISTS ai_suggestion_db;

USE resume_db;

-- 创建Resume表
CREATE TABLE IF NOT EXISTS api_resume (
    id CHAR(36) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    user_id VARCHAR(36) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
);

-- 创建ResumeVersion表
CREATE TABLE IF NOT EXISTS api_resumeversion (
    id CHAR(36) PRIMARY KEY,
    resume_id CHAR(36) NOT NULL,
    file_path VARCHAR(512) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_size INT NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_resume_id (resume_id),
    FOREIGN KEY (resume_id) REFERENCES api_resume(id) ON DELETE CASCADE
);

USE ai_suggestion_db;

-- 创建Suggestion表
CREATE TABLE IF NOT EXISTS api_suggestion (
    id CHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    resume_id VARCHAR(36) NOT NULL,
    job_description TEXT NOT NULL,
    score FLOAT NOT NULL,
    feedback TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_resume_id (resume_id)
);

-- 创建SuggestionFeedback表
CREATE TABLE IF NOT EXISTS api_suggestionfeedback (
    id CHAR(36) PRIMARY KEY,
    suggestion_id CHAR(36) NOT NULL,
    is_helpful BOOLEAN NOT NULL,
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (suggestion_id) REFERENCES api_suggestion(id) ON DELETE CASCADE
);
```

## 6. 总结

本文档详细设计了基于Django框架的简历管理服务和AI建议服务的微服务架构和数据模型。主要内容包括：

1. 整体架构设计，包括系统架构图和技术栈选择
2. 简历管理服务的项目结构、数据模型、API设计和S3服务集成
3. AI建议服务的项目结构、数据模型、API设计、OpenAI服务集成和简历服务集成
4. 认证和安全配置，包括JWT认证和CORS配置
5. 部署配置，包括Docker配置、Docker Compose配置和初始化数据库脚本

这个设计提供了一个完整的框架，可以作为开发这两个微服务的基础。在实际开发中，可能需要根据具体需求进行调整和扩展。

